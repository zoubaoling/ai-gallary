# 通义万相文生图部署指南

## 📋 部署清单

### 1. 环境变量配置
- [ ] 在云开发控制台配置 `DASHSCOPE_API_KEY`
- [ ] 获取阿里云百炼API Key

### 2. 云函数部署
- [ ] 部署 `qwenImageGeneration` 云函数
- [ ] 部署 `httpRequest` 云函数
- [ ] 验证云函数部署状态

### 3. 小程序配置
- [ ] 更新 `app.json` 添加 `t-progress` 组件
- [ ] 验证页面组件引用

### 4. 功能测试
- [ ] 测试图片生成功能
- [ ] 测试重新生成功能
- [ ] 测试错误处理

## 🚀 详细部署步骤

### 步骤1：配置环境变量

1. 登录微信开发者工具
2. 打开云开发控制台
3. 进入"设置" → "环境变量"
4. 添加环境变量：
   ```
   变量名: DASHSCOPE_API_KEY
   变量值: sk-your-dashscope-api-key
   ```

### 步骤2：部署云函数

#### 部署 qwenImageGeneration 云函数
1. 右键点击 `cloudfunctions/qwenImageGeneration` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

#### 部署 httpRequest 云函数
1. 右键点击 `cloudfunctions/httpRequest` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

### 步骤3：验证部署

在微信开发者工具控制台中运行：
```javascript
// 复制 test-qwen-integration.js 的内容到控制台
runQwenIntegrationTests();
```

### 步骤4：功能测试

1. **基础功能测试**
   - 打开创建页面
   - 输入提示词："一只可爱的小猫"
   - 点击"生成图片"按钮
   - 观察生成进度和结果

2. **重新生成测试**
   - 生成完成后点击"重新生成"按钮
   - 验证使用不同种子生成不同图片

3. **错误处理测试**
   - 输入空提示词测试验证
   - 网络异常情况测试

## 🔧 配置说明

### 通义万相API配置
- **模型**: wan2.2-t2i-plus
- **API地址**: https://dashscope.aliyuncs.com/api/v1
- **支持尺寸**: 512*512 到 1440*1440
- **生成数量**: 1-4张

### 云函数配置
- **超时时间**: 60秒
- **内存**: 256MB
- **环境**: Node.js 16

### 小程序配置
- **轮询间隔**: 2秒
- **最大轮询次数**: 60次
- **进度更新**: 实时显示

## 🐛 常见问题

### 1. 环境变量未配置
**错误**: `DASHSCOPE_API_KEY 环境变量未配置`
**解决**: 在云开发控制台正确配置环境变量

### 2. 云函数调用失败
**错误**: `云函数调用失败`
**解决**: 检查云函数部署状态，重新部署

### 3. 图片生成超时
**错误**: `图片生成超时`
**解决**: 检查网络连接，增加轮询次数

### 4. API Key无效
**错误**: `创建任务失败`
**解决**: 验证API Key是否正确，检查账户余额

## 📊 性能优化

### 1. 轮询优化
- 根据任务状态调整轮询间隔
- 实现指数退避策略

### 2. 缓存优化
- 缓存生成的图片URL
- 实现本地存储

### 3. 用户体验优化
- 添加生成进度动画
- 实现任务取消功能

## 🔒 安全考虑

### 1. API Key安全
- 使用环境变量存储API Key
- 不在客户端代码中暴露密钥

### 2. 输入验证
- 验证提示词长度和内容
- 过滤恶意输入

### 3. 访问控制
- 实现用户认证
- 限制生成频率

## 📈 监控和日志

### 1. 云函数日志
- 查看云函数执行日志
- 监控错误率和响应时间

### 2. 用户行为分析
- 统计生成成功率
- 分析用户使用模式

### 3. 性能监控
- 监控API调用次数
- 跟踪生成时间分布

## 🎯 后续优化

### 1. 功能增强
- [ ] 支持批量生成
- [ ] 添加图片编辑功能
- [ ] 实现风格迁移

### 2. 性能提升
- [ ] 实现图片压缩
- [ ] 添加CDN加速
- [ ] 优化加载速度

### 3. 用户体验
- [ ] 添加生成历史
- [ ] 实现收藏功能
- [ ] 支持分享到社交平台

## 📞 技术支持

如遇到问题，请检查：
1. 云函数部署状态
2. 环境变量配置
3. API Key有效性
4. 网络连接状态

更多技术支持请参考：
- [微信云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [阿里云百炼文档](https://help.aliyun.com/zh/dashscope/)
- [通义万相API文档](https://help.aliyun.com/zh/dashscope/developer-reference/api-details)
